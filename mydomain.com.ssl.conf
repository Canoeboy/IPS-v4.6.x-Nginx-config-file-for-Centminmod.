# Firstly read my README file before using this (to be updated 27-12-21)
# IPB4 Working NGINX site conf file
# Tested on IPB 4.6.9+ and Centminmod 123.09beta01
# THIS is an SSL Nginx config file for INVISION COMMUNITY run on a CENTMINMOD SERVER under NGINX
# This file is for FORCED SSL - all Non-SSL requests will be re-directed to SSL.
# Replace MYDOMAINNAME.COM with your DOMAIN NAME (OR IP address).
# Information gathered from
# Centminmod.com / Information pulled from multiple guides.
# Base building forum thread:  https://community.centminmod.com/threads/ipb-v4-1-x-files.4922/
# Ideally you need a centminmod config (/etc/centminmod/custom_config.inc) with LETSENCRYPT='Y' and then run option 2 for a VHOST to get the required SSL
# Centmin Mod Getting Started Guide
# Good Reads https://centminmod.com/getstarted.html
# For HTTP/2 SSL Setup
# Read https://centminmod.com/nginx_configure_https_ssl_spdy.html

# Redirect from www to non-www  forced SSL
# Uncomment, save file and restart Nginx to enable
# Test with 302, once working replace 302 with 301
 server {
       listen   80;
       server_name MYDOMAINNAME.COM www.MYDOMAINNAME.COM;
       return 302 https://$server_name$request_uri;
 }

server {
  listen 443 ssl http2 reuseport;
  server_name MYDOMAINNAME.COM www.MYDOMAINNAME.COM;
  include /usr/local/nginx/conf/ssl/MYDOMAINNAME.COM/MYDOMAINNAME.COM.crt.key.conf;
  include /usr/local/nginx/conf/ssl_include.conf;

# Generated 2021-12-24, Mozilla Guideline v5.6, nginx 1.21.1, OpenSSL 1.1.1m, intermediate configuration
# https://ssl-config.mozilla.org/#server=nginx&version=1.21.4&config=intermediate&openssl=1.1.1m&guideline=5.6
# Intermediate configuration
	ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    # before enabling HSTS line below read centminmod.com/nginx_domain_dns_setup.html#hsts
    # HSTS (ngx_http_headers_module is required) (63072000 seconds)
    add_header Strict-Transport-Security "max-age=63072000" always;
	add_header X-Frame-Options SAMEORIGIN;
	add_header X-Xss-Protection "1; mode=block" always;
	add_header X-Content-Type-Options "nosniff" always;
	ssl_buffer_size 1369;
	ssl_session_tickets on;

	#Enable ocsp stapling
	resolver 8.8.8.8 8.8.4.4 1.1.1.1 1.0.0.1 valid=10m;
	resolver_timeout 10s;
	ssl_stapling on;
  	ssl_stapling_verify on;
  
	access_log /home/nginx/domains/MYDOMAINNAME.COM/log/access.log combined buffer=256k flush=5m;
  	error_log /home/nginx/domains/MYDOMAINNAME.COM/log/error.log;

  	include /usr/local/nginx/conf/autoprotect/MYDOMAINNAME.COM/autoprotect-MYDOMAINNAME.COM.conf;
  	root /home/nginx/domains/MYDOMAINNAME.COM/public;
  	
  	include /usr/local/nginx/conf/503include-main.conf;

  	location / {
  	include /usr/local/nginx/conf/503include-only.conf;

  	#Block common exploits, sql injections etc
  	include /usr/local/nginx/conf/block.conf;

  	#Enables directory listings when index file not found
  	#autoindex  on;

  	#Shows file listing times as local time
  	autoindex_localtime on;

	#URL rewrites - added 24/12/2021
	try_files    $uri $uri/ /index.php;
	}

	location ~^(/page/).*(\.php)$ {
        try_files  $uri $uri/ /index.php;
    }

	  #Hide the fake admin directory
    # This must be commented out during the install.  Uncomment after install and admin directory name changed!
    #location ~^/admin/(.*)$ {
    #    deny all;
    #}

    # Secure real admin directory
    # Replace /your_admin_renamed_directory/ with your renamed directory.
    #location /your_admin_renamed_directory/ {
    #    auth_basic "Private";
    #    auth_basic_user_file /usr/local/nginx/conf/htpasswd_admin_php;
    #        include /usr/local/nginx/conf/php.conf;
    #        allow 127.0.0.1;
    #        allow YOURIPADDRESS;
    #        deny all;
    #}

	  #Invision Board PHP/CGI Protection

    #Allow access to interface files
    location ~^(/applications/*/interface/).*(\.php)$ {
      allow all;
    }

    location ~^(/uploads/).*(\.php)$ {
        deny     all;
    }
    
    location ~^(/system/).*(\.php)$ {
        deny     all;
    }

    location ~^(/datastore/).*(\.php)$ {
        deny     all;
    }

    location ~^(/plugins/).*(\.php)$ {
        deny     all;
    }

    location ~^(/applications/blog/).*(\.php)$ {
        deny     all;
    }

    location ~^(/applications/calendar/).*(\.php)$ {
        deny     all;
    }

    location ~^(/applications/chat/).*(\.php)$ {
        deny     all;
            }

    location ~^(/applications/cms/).*(\.php)$ {
        deny     all;
    }

    location ~^(/applications/core/).*(\.php)$ {
        deny     all;
    }

    location ~^(/applications/downloads/).*(\.php)$ {
        deny     all;
    }

    location ~^(/applications/forums/).*(\.php)$ {
        deny     all;
    }

    location ~^(/applications/gallery/).*(\.php)$ {
        deny     all;
    }

    location ~^(/applications/nexus/).*(\.php)$ {
        deny     all;
    }


  include /usr/local/nginx/conf/php.conf;

  include /usr/local/nginx/conf/pre-staticfiles-local-MYDOMAINNAME.COM.conf;
  include /usr/local/nginx/conf/pre-staticfiles-global.conf;
  include /usr/local/nginx/conf/staticfiles.conf;
  include /usr/local/nginx/conf/drop.conf;
  #include /usr/local/nginx/conf/errorpage.conf;
  include /usr/local/nginx/conf/vts_server.conf;
}

